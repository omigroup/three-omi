<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>three-omi | Examples: Audio Listener</title>
    <link rel="stylesheet" href="./styles.css" />
    <style>
      .controls {
        position: absolute;
        z-index: 1;
        color: white;
        margin: 12px 16px 16px 16px;
        font-size: 12px;
      }

      .controls p {
        margin: 4px;
      }

      .hide {
        display: none;
      }

      #load-button {
        position: absolute;
        color: white;
        background-color: transparent;
        border: 1px solid white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        justify-items: center;
        border-radius: 6px;
        padding: 8px 12px;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <button id="load-button">Load Example</button>
    <script type="module">
      import {
        Scene,
        AudioListener,
        PerspectiveCamera,
        WebGLRenderer,
        ACESFilmicToneMapping,
        sRGBEncoding,
        AnimationMixer,
        LoopRepeat,
        Clock,
        Audio,
        PositionalAudio,
        PlaneBufferGeometry,
        SphereBufferGeometry,
        BoxBufferGeometry,
        MeshBasicMaterial,
        Mesh,
        AudioLoader,
      } from "three";
      import { GLTFExporter } from "three/examples/jsm/exporters/GLTFExporter";
      import { GLTFExporterAudioEmitterExtension } from "../src/three-omi";

      async function main() {
        const scene = new Scene();

        const camera = new PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.001, 1000);
        camera.position.set(0, 1.6, 5);
        scene.add(camera);
        const audioListener = new AudioListener();
        camera.add(audioListener);

        scene.add(
          new Mesh(
            new PlaneBufferGeometry(10, 10).rotateX(-Math.PI / 2),
            new MeshBasicMaterial({ color: 0xFFFFFF })
          )
        );

        const box = new Mesh(
          new BoxBufferGeometry(1, 1, 1),
          new MeshBasicMaterial({ color: 0xFF0000 })
        );
        box.position.set(0, 0.5, 0);
        scene.add(box);

        const sphere = new Mesh(
          new SphereBufferGeometry(1),
          new MeshBasicMaterial({ color: 0x0000FF })
        );
        sphere.position.set(2, 0.5, 0);
        scene.add(sphere);

        const ambientAudio = new Audio(audioListener);
        const ambientAudioBuffer = await new AudioLoader().loadAsync("../scenes/simple/ambient.mp3");
        ambientAudio.setBuffer(ambientAudioBuffer);
        ambientAudio.setLoop(true);
        ambientAudio.setVolume(0.5);
        ambientAudio.play();
        scene.add(ambientAudio);

        const talkingAudio = new PositionalAudio(audioListener);
        const talkingAudioBuffer = await new AudioLoader().loadAsync("../scenes/simple/talking.mp3");
        talkingAudio.setBuffer(talkingAudioBuffer);
        talkingAudio.setLoop(true);
        talkingAudio.setVolume(0.5);
        talkingAudio.play();
        sphere.add(talkingAudio);

        const encodeMp3 = async (buffer) => {
          
        };

        const exportButton = document.createElement("button");
        exportButton.style.position = "absolute";
        exportButton.innerText = "Export GLTF";
        exportButton.addEventListener("click", () => {
          const gltfExporter = new GLTFExporter();
          gltfExporter.register(writer => new GLTFExporterAudioEmitterExtension(writer, encodeMp3));
          gltfExporter.parse(scene, (buffer) => {
            const blob = new Blob([buffer], { type: "application/octet-stream" });
            const link = document.createElement("a");
			      link.style.display = "none";
			      document.body.appendChild(link);
            link.href = URL.createObjectURL(blob);
            link.download = "scene.glb";
            link.click();
            link.remove();
          }, { binary: true });
        });
        document.body.appendChild(exportButton);

        const canvas = document.getElementById("canvas");
        const renderer = new WebGLRenderer({ antialias: true, canvas });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1;
        renderer.outputEncoding = sRGBEncoding;
        renderer.setAnimationLoop(() => {
          renderer.render(scene, camera);
        });

        function onResize() {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('resize', onResize);
        onResize();
      }

      const loadButton = document.getElementById("load-button");

      const onLoad = () => {
        loadButton.removeEventListener("click", onLoad);
        loadButton.innerText = "Loading...";

        main()
          .then(() => {
            loadButton.remove();
          })
          .catch(console.error);
      };

      loadButton.addEventListener("click", onLoad);
    </script>
  </body>
</html>
